{% extends 'base.html' %}
{% block content %}




<div class="container">
    <div>
        <h1>Add Bins to your Schedule</h1>
        <p>Schedule Title: {{ schedule }}</p>
        <p>Schedule Location: {{ schedule.locations }}</p>
        <p>Schedule Description{{ schedule.description }}</p>
    </div>
    <div id='calendar'></div>
    <!-- Modal for Event Creation -->
    <div class="modal" tabindex="-1" id="createEventModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="create-event-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Pick a bin type:
                        <select name="bin-type" id="bin-type">
                            <option value="restmuell">Restmüll</option>
                            <option value="biomuell">Biomüll</option>
                            <option value="papiermuell">Papiermüll</option>
                            <option value="gelbe-tonne">Gelbe Tonne</option>
                        </select>
                    </p>
                    <p>
                        This bin will be collected every:
                        <select name="recurrence" id="recurrence">
                            <option value="0">no recurrence</option>
                            <option value="1">weekly</option>
                            <option value="2">every other week</option>
                            <option value="3">every third week</option>
                            <option value="4">every fourth week</option>
                        </select>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-event">Save changes</button>
                </div>
            </div>
        </div>
    </div>


    <!-- Modal for Event Deletion -->
    <div class="modal" tabindex="-1" id="deleteEventModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="delete-event-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Pick a bin type:
                        <select name="delete-select" id="delete-select">
                            <option value="only this event">only this event</option>
                            <option value="all the events in this group">all the events in this group</option>
                        </select>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="delete-event">Delete</button>
                </div>
            </div>
        </div>
    </div>


    <form method="post">
        {% csrf_token %}
    </form>
    <div class="btn btn-primary" id="submit-button">Save</div>
</div>

<!-- rrule lib -->
<script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>

<!-- fullcalendar bundle -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

<!-- the rrule-to-fullcalendar connector. must go AFTER the rrule lib -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.11/index.global.min.js'></script>

<script>

    function getWeekDay(date) {
        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return weekdays[new Date(date).getDay()];
    }

    let eventDate = 0;
    let current_id = 0;
    let createEventModal = null;
    let deleteEventModal = null;
    let calendar = null;


    function getMaxId(events) {
        let max_id = 0;
        for (let event of events) {
            if (event.id > max_id) {
                max_id = event.id;
            }
        }
        current_id = max_id + 1;
    }

    function createEvent(date) {
        createEventModal = new bootstrap.Modal(document.getElementById('createEventModal'));
        // -> Credit for getWeekday: https://www.w3schools.com/jsref/jsref_getday.asp
        document.getElementById('create-event-modal-title').textContent = `Create a new event on ${getWeekDay(date)}, ${date}`;
        // -> Credit for selectedIndex: https://www.w3schools.com/jsref/prop_select_selectedindex.asp
        document.getElementById('bin-type').selectedIndex = 0;
        document.getElementById('recurrence').selectedIndex = 0;
        eventDate = new Date(date);
        createEventModal.show();
    }


    function handleModalSubmit(event, info, submitButton) {
        console.log(info.event.id);
        event.preventDefault();
        deleteEventModal.hide();
        submitButton.removeEventListener('click', handleModalSubmit);

        if (document.getElementById('delete-select').value === 'only this event') {
            info.event.exdate += [info.event.startStr];
        } else {
            var events = calendar.getEvents();
            for (var event of events) {
                if (event.groupId === event.id) {
                    event.remove();
                }
            }
        }
        calendar.refetchEvents();
    }


    function renderCalendar() {
        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            defaultAllDay: true,
            dateClick: function (info) {
                createEvent(info.dateStr);
            },
            eventMouseEnter: function (info) {
                info.el.style.backgroundColor = 'lightblue';
                info.el.style.border = 'none';
                info.el.style.color = 'white';
                info.el.innerHTML += '<i class="fas fa-trash-alt"></i>';
            },
            eventMouseLeave: function (info) {
                info.el.style.backgroundColor = '';
                info.el.innerHTML = `${info.event.title}<br>`;
                info.el.style.color = 'white';
            },
            eventClick: function (info) {
                deleteEventModal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
                document.getElementById('delete-event-modal-title').textContent = `Delete event: ${info.event.title} from ${info.event.start}`;

                let submitButton = document.getElementById('delete-event');
                submitButton.addEventListener('click', (event) => handleModalSubmit(event, info, submitButton));

                deleteEventModal.show();
            },
            events: [
                {
                    id: 0,
                    title: 'restmuell',
                    start: '2024-04-13',
                    groupId: '999',
                    rrule: {
                        freq: 'weekly',
                        interval: 1,
                        dtstart: '2024-04-13', // will also accept '20120201T103000'
                        until: '2024-05-13' // will also accept '20120201'
                    },
                    exdate: ['2024-04-27'],
                },
                {
                    id: 1,
                    title: 'biomuell',
                    start: '2024-04-14',
                    groupId: '1',
                }
            ]
        });
        calendar.render();
    }


    function postCalendarEvents() {
        // Should I use Ajax here instead?
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const json_body = JSON.stringify(get_calender_event_objects(calendar));
        console.log(json_body);
        fetch("{% url 'add_bins' schedule.id %}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                // Include CSRF token in the header
                'X-CSRFToken': csrftoken
            },
            body: json_body,
        });
    }

    function toPlainObjectWithRRule(event) {
        let event_object = event.toPlainObject();
        // what if the obj is not recurring?
        if (event._def.recurringDef) {
            const event_rrule_object = {
                freq: event._def.recurringDef.typeData.rruleSet._rrule[0].options.freq,
                interval: event._def.recurringDef.typeData.rruleSet._rrule[0].options.interval,
                dstart: event._def.recurringDef.typeData.rruleSet._rrule[0].options.dtstart.toISOString().split('T')[0],
                until: event._def.recurringDef.typeData.rruleSet._rrule[0].options.until.toISOString().split('T')[0],
            };
            event_object.rrule = event_rrule_object;
        }
        return event_object;
    }

    function get_calender_event_objects() {
        let events = [];
        for (let event of calendar.getEvents()) {
            events.push(toPlainObjectWithRRule(event));
        }
        return events;
    }

    document.addEventListener('DOMContentLoaded', function () {
        renderCalendar();

        getMaxId(calendar.getEvents());

        // -> Credit for query selector: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector?retiredLocale=de
        document.getElementById('submit-button').addEventListener('click', function (e) {
            e.preventDefault();
            postCalendarEvents(calendar);
        });

        document.getElementById('save-event').addEventListener('click', function () {
            const bin_type = document.getElementById('bin-type').value;
            const recurrence = document.getElementById('recurrence').value;
            if (recurrence === '0') {
                calendar.addEvent({
                    id: current_id,
                    title: bin_type,
                    start: eventDate,
                    groupId: bin_type,
                });
            } else {
                let endRecurrence = new Date(eventDate).setFullYear(eventDate.getFullYear() + 1);
                calendar.addEvent({
                    id: current_id,
                    title: bin_type,
                    start: eventDate,
                    groupId: bin_type,
                    rrule: {
                        freq: 'weekly',
                        interval: recurrence,
                        dtstart: eventDate,
                        until: endRecurrence
                    }
                });
            }
            current_id++;
            createEventModal.hide();
        });
    });



</script>

{% endblock %}