{% extends 'base.html' %}
{% block content %}

<div class="container">
    <div>
        <h1>Add Bins to your Schedule</h1>
        <p>Schedule Title: {{ schedule }}</p>
        <p>Schedule Location: {{ schedule.locations }}</p>
        <p>Schedule Description{{ schedule.description }}</p>
    </div>

    <!-- FullCalendar -->
    <div id='calendar'></div>

    <!-- Modal for Event Creation -->
    <div class="modal" tabindex="-1" id="createEventModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="create-event-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Pick a bin type:
                        <select name="bin-type" id="bin-type">
                            <option value="Restmüll">Restmüll</option>
                            <option value="Biomüll">Biomüll</option>
                            <option value="Papiermüll">Papiermüll</option>
                            <option value="Gelbe Tonne">Gelbe Tonne</option>
                        </select>
                    </p>
                    <p>
                        This bin will be collected every:
                        <select name="recurrence" id="recurrence">
                            <option value="0">no recurrence</option>
                            <option value="1">weekly</option>
                            <option value="2">every other week</option>
                            <option value="3">every third week</option>
                            <option value="4">every fourth week</option>
                        </select>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="save-event">Save changes</button>
                </div>
            </div>
        </div>
    </div>

    <!-- Modal for Event Deletion -->
    <div class="modal" tabindex="-1" id="deleteEventModal">
        <div class="modal-dialog">
            <div class="modal-content">
                <div class="modal-header">
                    <h5 class="modal-title" id="delete-event-modal-title"></h5>
                    <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
                </div>
                <div class="modal-body">
                    <p>
                        Pick a bin type:
                        <select name="delete-select" id="delete-select">
                            <option value="only this event">only this event</option>
                            <option value="all the events in this group">all the events in this group</option>
                        </select>
                    </p>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Close</button>
                    <button type="button" class="btn btn-primary" id="delete-event">Delete</button>
                </div>
            </div>
        </div>
    </div>

    <!-- CSRF Token for the POST method that sends the events json data -->
    <form method="post">
        {% csrf_token %}
    </form>

    <!-- Button to save the events by triggering the POST request -->
    <div class="btn btn-primary" id="submit-button">Save</div>
</div>

<!-- Json string of events in this schedule -->
{{ event_data|json_script:"event-data" }}

<!-- rrule lib -->
<script src='https://cdn.jsdelivr.net/npm/rrule@2.6.4/dist/es5/rrule.min.js'></script>

<!-- fullcalendar bundle -->
<script src='https://cdn.jsdelivr.net/npm/fullcalendar@6.1.11/index.global.min.js'></script>

<!-- the rrule-to-fullcalendar connector. must go AFTER the rrule lib -->
<script src='https://cdn.jsdelivr.net/npm/@fullcalendar/rrule@6.1.11/index.global.min.js'></script>

<!-- Script to handle full Calendar -->
<script>


    // Global variables
    let eventDate = 0;
    let current_id = 0;
    let createEventModal = null;
    let deleteEventModal = null;
    let calendar = null;

    // Utility functions

    /**
     * Calculates the maximum ID value from the given events array and returns the next available ID.
     *
     * @param {Array} events - The array of events.
     * @returns {number} - The next available ID.
     */
    function getMaxId(events) {
        let max_id = 0;
        for (let event of events) {
            if (event.id > max_id) {
                max_id = event.id;
            }
        }
        current_id = max_id + 1;
    }

    // -> Credit for getWeekday: https://www.w3schools.com/jsref/jsref_getday.asp
    /**
     * Returns the week day for a given date.
     *
     * @param {string} date - The date in string format.
     * @returns {string} - The week day corresponding to the given date.
     */
    function getWeekDay(date) {
        const weekdays = ['Sunday', 'Monday', 'Tuesday', 'Wednesday', 'Thursday', 'Friday', 'Saturday'];
        return weekdays[new Date(date).getDay()];
    }

    /**
     * Converts an event object to a plain object with recurrence rule (RRule) information.
     * If the event is recurring, it extracts the RRule information and adds it to the event object.
     *
     * @param {Object} event - The event object to convert.
     * @returns {Object} - The converted event object with RRule information.
     */
    function toPlainObjectWithRRule(event) {
        let event_object = event.toPlainObject();
        if (event._def.recurringDef) {
            const event_rrule_object = {
                freq: event._def.recurringDef.typeData.rruleSet._rrule[0].options.freq,
                interval: event._def.recurringDef.typeData.rruleSet._rrule[0].options.interval,
                dstart: event._def.recurringDef.typeData.rruleSet._rrule[0].options.dtstart.toISOString().split('T')[0],
                until: event._def.recurringDef.typeData.rruleSet._rrule[0].options.until.toISOString().split('T')[0],
            };
            event_object.rrule = event_rrule_object;
        }
        return event_object;
    }

    /**
     * Creates a new event on the specified date.
     * Does this by resetting and showing the create event modal.
     *
     * @param {string} date - The date for which the event is to be created.
     */
    function createEvent(date) {
        createEventModal = new bootstrap.Modal(document.getElementById('createEventModal'));
        document.getElementById('create-event-modal-title').textContent = `Create a new event on ${getWeekDay(date)}, ${date}`;
        // -> Credit for selectedIndex: https://www.w3schools.com/jsref/prop_select_selectedindex.asp
        document.getElementById('bin-type').selectedIndex = 0;
        document.getElementById('recurrence').selectedIndex = 0;
        eventDate = new Date(date);
        createEventModal.show();
    }


    // This should handle Event removal but it is not working yet
    // To get this to work I need to add exdates to the rrule in the event object
    function handleModalSubmit(event, info, submitButton) {
        console.log(info.event.id);
        event.preventDefault();
        deleteEventModal.hide();
        submitButton.removeEventListener('click', handleModalSubmit);

        if (document.getElementById('delete-select').value === 'only this event') {
            info.event.exdate += [info.event.startStr];
        } else {
            var events = calendar.getEvents();
            for (var event of events) {
                if (event.groupId === event.id) {
                    event.remove();
                }
            }
        }
        calendar.refetchEvents();
    }

    /**
     * Retrieves JSON events from the 'event-data' element and parses them into an object.
     *
     * @returns {Object} The parsed JSON events.
     */
    function getJsonEvents() {
        let json_events = JSON.parse(document.getElementById('event-data').textContent);
        json_events = JSON.parse(json_events);
        return json_events;
    }

    /**
     * Renders the calendar with the provided event data.
     * Adjusts the Settings of the FullCalendar
     *
     * @function renderCalendar
     */
    function renderCalendar() {
        json_events = getJsonEvents();

        const calendarEl = document.getElementById('calendar');
        calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'dayGridMonth',
            defaultAllDay: true,
            dateClick: function (info) {
                createEvent(info.dateStr);
            },
            eventMouseEnter: function (info) {
                info.el.style.backgroundColor = 'lightblue';
                info.el.style.border = 'none';
                info.el.style.color = 'white';
                info.el.innerHTML += '<i class="fas fa-trash-alt"></i>';
            },
            eventMouseLeave: function (info) {
                info.el.style.backgroundColor = '';
                info.el.innerHTML = `${info.event.title}<br>`;
                info.el.style.color = 'white';
            },
            eventClick: function (info) {
                deleteEventModal = new bootstrap.Modal(document.getElementById('deleteEventModal'));
                document.getElementById('delete-event-modal-title').textContent = `Delete event: ${info.event.title} from ${info.event.start}`;

                let submitButton = document.getElementById('delete-event');
                submitButton.addEventListener('click', (event) => handleModalSubmit(event, info, submitButton));

                deleteEventModal.show();
            },
            events: json_events,
        });
        calendar.render();
    }


    /**
     * This function is responsible for posting calendar events to the server.
     * It includes The CSRF token that is generated in the Django template.
     * The function expects a redirect URL from the server.
     *
     * @returns {void}
     */
    function postCalendarEvents() {
        // Should I use Ajax here instead?
        const csrftoken = document.querySelector('[name=csrfmiddlewaretoken]').value;
        const json_body = JSON.stringify(get_calender_event_objects(calendar));
        console.log(json_body);
        fetch("{% url 'add_bins' schedule.id %}", {
            method: "POST",
            headers: {
                'Content-Type': 'application/json',
                // Include CSRF token in the header
                'X-CSRFToken': csrftoken
            },
            body: json_body,
        }).then(response => response.json()).then(data => {
            if (data.redirect_url) {
                window.location.href = data.redirect_url;
            }
        }).catch(error => {
            console.error('Error:', error);
        });
    }

    /**
     * Retrieves the calendar event objects.
     * @returns {Array} An array of calendar event objects.
     */
    function get_calender_event_objects() {
        let events = [];
        for (let event of calendar.getEvents()) {
            console.log(event.toPlainObject());
            events.push(toPlainObjectWithRRule(event));
        }
        return events;
    }

    // On document load
    document.addEventListener('DOMContentLoaded', function () {
        renderCalendar();

        // This is to know where to continue the ID count
        getMaxId(calendar.getEvents());

        // -> Credit for query selector: https://developer.mozilla.org/en-US/docs/Web/API/Document/querySelector?retiredLocale=de
        // Call the postCalendarEvents function when the submit button is clicked
        document.getElementById('submit-button').addEventListener('click', function (e) {
            e.preventDefault();
            postCalendarEvents(calendar);
        });

        // Save the event when the save button is clicked
        document.getElementById('save-event').addEventListener('click', function () {
            const bin_type = document.getElementById('bin-type').value;
            const recurrence = document.getElementById('recurrence').value;
            if (recurrence === '0') {
                calendar.addEvent({
                    id: current_id,
                    title: bin_type,
                    start: eventDate,
                    groupId: bin_type,
                });
            } else {
                // -> Credit for adding a year to a date: https://developer.mozilla.org/en-US/docs/Web/JavaScript/Reference/Global_Objects/Date/setFullYear
                let endRecurrence = new Date(new Date(eventDate).setFullYear(eventDate.getFullYear() + 1));
                calendar.addEvent({
                    id: current_id,
                    title: bin_type,
                    start: eventDate,
                    groupId: bin_type,
                    rrule: {
                        freq: 'weekly',
                        interval: recurrence,
                        dtstart: eventDate,
                        until: endRecurrence
                    }
                });
            }
            current_id++;
            createEventModal.hide();
        });
    });

</script>

{% endblock %}